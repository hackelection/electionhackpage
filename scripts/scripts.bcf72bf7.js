"use strict";angular.module("electionhackApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase","firebase.utils","simpleLogin","angularLoad"]),angular.module("electionhackApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("firebase.config",[]).constant("FBURL","https://electionhack.firebaseio.com").constant("SIMPLE_LOGIN_PROVIDERS",["password","facebook","twitter"]).constant("loginRedirectPath","/login"),angular.module("firebase.utils",["firebase","firebase.config"]).factory("fbutil",["$window","FBURL","$firebase",function(a,b,c){function d(a){for(var b=0;b<a.length;b++)if(angular.isArray(a[b]))a[b]=d(a[b]);else if("string"!=typeof a[b])throw new Error("Argument "+b+" to firebaseRef is not a string: "+a[b]);return a.join("/")}function e(){var c=new a.Firebase(b),e=Array.prototype.slice.call(arguments);return e.length&&(c=c.child(d(e))),c}function f(a,b){var d=e(a);return b=angular.extend({},b),angular.forEach(["limitToFirst","limitToLast","orderByKey","orderByChild","orderByPriority","startAt","endAt"],function(a){if(b.hasOwnProperty(a)){var c=b[a];d=d[a].apply(d,angular.isArray(c)?c:[c]),delete b[a]}}),c(d,b)}return{syncObject:function(){return f.apply(null,arguments).$asObject()},syncArray:function(){return f.apply(null,arguments).$asArray()},ref:e}}]),angular.module("electionhackApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),function(){angular.module("simpleLogin",["firebase","firebase.utils","firebase.config"]).factory("authRequired",["simpleLogin","$q",function(a,b){return function(){return a.auth.$requireAuth().then(function(a){return a?a:b.reject({authRequired:!0})})}}]).factory("simpleLogin",["$firebaseAuth","fbutil","$q","$rootScope","createProfile",function(a,b,c,d,e){function f(){i.initialized=!0,i.user=g.$getAuth()||null,angular.forEach(h,function(a){a(i.user)})}var g=a(b.ref()),h=[],i={auth:g,user:null,initialized:!1,getUser:function(){return g.$getAuth()},login:function(a,b){return g.$authWithOAuthPopup(a,b)},anonymousLogin:function(a){return g.$authAnonymously(a)},passwordLogin:function(a,b){return g.$authWithPassword(a,b)},logout:function(){g.$unauth()},createAccount:function(a,b,c){return g.$createUser({email:a,password:b}).then(function(){return i.passwordLogin({email:a,password:b},c)}).then(function(b){return e(b.uid,a).then(function(){return b})})},changePassword:function(a,b,c){return g.$changePassword({email:a,oldPassword:b,newPassword:c})},changeEmail:function(a,b,c){return g.$changeEmail({password:a,oldEmail:c,newEmail:b})},removeUser:function(a,b){return g.$removeUser({email:a,password:b})},watch:function(a,b){h.push(a),g.$waitForAuth(a);var c=function(){var b=h.indexOf(a);b>-1&&h.splice(b,1)};return b&&b.$on("$destroy",c),c}};return g.$onAuth(f),i}]).factory("createProfile",["fbutil","$q","$timeout",function(a,b,c){return function(d,e,f){function g(a){return h(a.substr(0,a.indexOf("@"))||"")}function h(a){a+="";var b=a.charAt(0).toUpperCase();return b+a.substr(1)}var i=a.ref("users",d),j=b.defer();return i.set({email:e,name:f||g(e)},function(a){c(function(){a?j.reject(a):j.resolve(i)})}),j.promise}}])}(),angular.module("electionhackApp").controller("LoginCtrl",["$scope","simpleLogin","$location",function(a,b,c){function d(){c.path("/run")}function e(b){a.err=b}a.oauthLogin=function(c){a.err=null,b.login(c,{rememberMe:!0}).then(d,e)},a.anonymousLogin=function(){a.err=null,b.anonymousLogin({rememberMe:!0}).then(d,e)},a.passwordLogin=function(c,f){a.err=null,b.passwordLogin({email:c,password:f},{rememberMe:!0}).then(d,e)},a.createAccount=function(c,f,g){console.log(f,g),a.err=null,f?g?f!==g?a.err="Passwords do not match":b.createAccount(c,f,{rememberMe:!0}).then(d,e):a.err="Please confirm your password":a.err="Please enter a password"}}]),angular.module("electionhackApp").controller("LogoutCtrl",["$scope","simpleLogin","$location",function(a,b,c){b.logout(),c.path("/")}]),angular.module("electionhackApp").controller("AccountCtrl",["$scope","user","simpleLogin","fbutil","$timeout",function(a,b,c,d,e){function f(a){h(a,"danger")}function g(a){h(a,"success")}function h(b,c){var d={text:b+"",type:c};a.messages.unshift(d),e(function(){a.messages.splice(a.messages.indexOf(d),1)},1e4)}function i(b){j&&j.$destroy(),j=d.syncObject("users/"+b.uid),j.$bindTo(a,"profile")}a.user=b,a.logout=c.logout,a.messages=[];var j;i(b),a.changePassword=function(b,d,e){a.err=null,b&&d?d!==e?f("Passwords do not match"):c.changePassword(j.email,b,d).then(function(){g("Password changed")},f):f("Please enter all fields")},a.changeEmail=function(b,d){a.err=null,c.changeEmail(b,d,j.email).then(function(){j.email=d,j.$save(),g("Email changed")})["catch"](f)}}]),angular.module("electionhackApp").directive("ngShowAuth",["simpleLogin","$timeout",function(a,b){var c;return a.watch(function(a){c=!!a}),{restrict:"A",link:function(d,e){function f(){b(function(){e.toggleClass("ng-cloak",!c)},0)}e.addClass("ng-cloak"),a.watch(f,d),a.getUser(f)}}}]),angular.module("electionhackApp").directive("ngHideAuth",["simpleLogin","$timeout",function(a,b){var c;return a.watch(function(a){c=!!a}),{restrict:"A",link:function(d,e){function f(){b(function(){e.toggleClass("ng-cloak",c!==!1)},0)}e.addClass("ng-cloak"),a.watch(f,d),a.getUser(f)}}}]),angular.module("electionhackApp").config(["$routeProvider","SECURED_ROUTES",function(a,b){a.whenAuthenticated=function(c,d){return d.resolve=d.resolve||{},d.resolve.user=["authRequired",function(a){return a()}],a.when(c,d),b[c]=!0,a}}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).whenAuthenticated("/logout",{template:"",controller:"LogoutCtrl"}).whenAuthenticated("/account",{templateUrl:"views/account.html",controller:"AccountCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).whenAuthenticated("/run",{templateUrl:"views/profileform.html",controller:"ProfileFormCtrl"}).whenAuthenticated("/campaign",{templateUrl:"views/campaign.html",controller:"CampaignCtrl"}).when("/congratulations",{templateUrl:"views/congratulations.html",controller:"CongratulationsCtrl"}).when("/signature/:candidate",{templateUrl:"views/signature.html",controller:"SignatureCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","simpleLogin","SECURED_ROUTES","loginRedirectPath",function(a,b,c,d,e){function f(a){!a&&g(b.path())&&b.path(e)}function g(a){return d.hasOwnProperty(a)}c.watch(f,a),a.$on("$routeChangeError",function(a,c,d,f){"AUTH_REQUIRED"===f&&b.path(e)})}]).constant("SECURED_ROUTES",{}),angular.module("electionhackApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("electionhackApp").controller("ProfileFormCtrl",["$scope","user","$http",function(a,b,c){var d=0;a.profile={},a.email=b.password.email,a.validation={errors:!1},a.submitStatus={submitting:!1,submitted:!1,error:!1},a.notDone=!0,a.stages=[{name:"Basic info",open:!0,complete:!1,fields:["firstName","otherNames","lastName","dobDay","dobMonth","dobYear"]},{name:"Constituency info",open:!1,complete:!1,fields:["constituency"]},{name:"Contact info",open:!1,complete:!1,fields:["addrFirst","addrSecond","addrCity","addrPc"]},{name:"Submit",open:!1,complete:!0}];var e=function(b,c){for(var d=a.stages[b].fields,e=0;e<d.length;e++)!f(d[e],c[d[e]]);return!0},f=function(a,b){return void 0===a||void 0===b?!1:!0};a.advance=function(b){console.log(a.wizard),e(d,b)?(a.validation.errors=!1,a.stages[d].open=!1,a.stages[d].complete=!0,d+=1,d>2&&(a.notDone=!1),a.stages[d].open=!0):(a.validation.errors=!0,console.log("You did not fill in the form correctly!"))},a.back=function(){a.validation.errors=!1,a.stages[d].open=!1,d>0&&(d-=1),a.stages[d].open=!0},a.submitProfile=function(b){a.submitStatus.submitting=!0,c.get("http://electionformfiller.herokuapp.com/",{params:{addr_city:b.addrCity,addr_first:b.addrFirst,addr_second:b.addrSecond,firstname:b.firstName,DoB_d:b.dobDay,DoB_m:b.dobMonth,DoB_y:b.dobYear,commonforename:b.firstName,commonsurname:b.lastName,othernames:b.otherNames,surname:b.lastName,addr_postcode:b.addrPc,constituency:b.constituency,email:a.email}}).success(function(b){a.submitStatus.submitting=!1,a.submitStatus.submitted=!0,console.log(b)}).error(function(b){a.submitStatus.submitting=!1,a.submitStatus.error=!0,console.log(b)})}}]),angular.module("electionhackApp").controller("CampaignCtrl",["$scope","user","fbutil","$location",function(a,b,c,d){a.showValidation=!1,a.myCrowdfund=c.syncObject("campaigns/"+b.uid),a.signatures=c.syncArray("signatures/"+b.uid),a.cfRegex=/https?:\/\/www\.crowdfunder\.co\.uk\/([^\/?]+)(?=\/?(?:$|\?))/,a.addCrowdfunder=function(d,e){if(d.$valid){a.showValidation=!1;var f={},g=a.cfRegex.exec(e),h=g[1];f[b.uid]={raised:0,src:h},c.ref("campaigns").update(f)}else a.showValidation=!0},a.removeCrowdfunder=function(){c.ref("campaigns/"+b.name).remove()},a.finish=function(){d.path("/congratulations")}}]),angular.module("electionhackApp").directive("campaign",["$http","angularLoad",function(a,b){return{restrict:"E",scope:{src:"@"},link:function(a,c){a.$watch("src",function(){var d="http://www.crowdfunder.co.uk/"+a.src+"/widget.js/";b.loadScript(d).then(function(){c.html(html)})["catch"](function(){c.html("invalid campaign")})})}}}]),angular.module("electionhackApp").controller("CongratulationsCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("electionhackApp").controller("SignatureCtrl",["$scope","$routeParams","fbutil",function(a,b,c){a.userId=b.candidate,a.crowdfund=c.syncObject("campaigns/"+a.userId),a.form=c.syncObject("forms/"+a.userId),a.signatures=c.syncArray("signatures/"+a.userId);var d=document.querySelector("canvas"),e=new SignaturePad(d);a.saveSignature=function(){e.isEmpty()||a.signatures.$add({electoralNumber:a.electoralNumber,signature:e.toDataURL()})}}]);